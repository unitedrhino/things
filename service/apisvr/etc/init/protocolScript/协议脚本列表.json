[{"ID":1,"Name":"有功电能差值新增","TriggerDir":1,"TriggerTimer":1,"TriggerHandle":"thing","TriggerType":"property","ScriptLang":1,"Script":"import \"log\"\nimport \"context\"\nimport \"deviceMsg\"\nimport \"json\"\nimport \"dm\"\nimport \"strings\"\nimport \"utils\"\n/*\n   PublishMsg struct { //发布消息结构体定义\n       Handle       string `json:\"handle\"` //对应 mqtt topic的第一个 thing ota config 等等\n       Type         string `json:\"type\"`   //操作类型 从topic中提取 物模型下就是   property属性 event事件 action行为\n       Payload      []byte `json:\"payload\"` //对应mqtt的payload\n       Timestamp    int64  `json:\"timestamp\"` //毫秒时间戳\n       ProductID    string `json:\"productID\"` //发送设备的产品ID\n       DeviceName   string `json:\"deviceName\"` //发送设备的设备ID\n       Explain      string `json:\"explain\"`      //内部使用的拓展字段\n       ProtocolCode string `json:\"protocolCode\"` //协议网关code\n   }\n*/\n\n/*\n数据:\n{\n    \"method\": \"packReport\",\n    \"msgToken\": \"10591\",\n    \"timestamp\": 1747276108116,\n    \"properties\": [\n\n    ],\n    \"events\": [\n\n    ],\n    \"subDevices\": [\n        {\n            \"productID\": \"66\",\n            \"deviceName\": \"1BL6-2\",\n            \"properties\": [\n                {\n                    \"timestamp\": 1747276108116,\n                    \"params\": {\n                        \"Ep\": 0.8,\n                        \"Ia\": 0,\n                        \"Ib\": 0,\n                        \"Ic\": 0,\n                        \"PFs\": 0,\n                        \"Ps\": 0,\n                        \"Ua\": 235.6,\n                        \"Ub\": 236.2,\n                        \"Uc\": 235.9\n                    }\n                }\n            ],\n            \"events\": [\n\n            ]\n        }\n    ]\n}\n*/\n\nfunc Handle(ctx context.Context,req *deviceMsg.PublishMsg) *deviceMsg.PublishMsg{\n\tlog.Print(req)\n    var tReq deviceMsg.ThingReq\n    err:=json.Unmarshal(req.Payload,\u0026tReq)\n    if err!=nil{\n        return req\n    }\n    if tReq.Method!=\"packReport\"{\n        return nil\n    }\n    for _,subDev:=range tReq.SubDevices{\n        for _,p:=range subDev.Properties{\n            ep:=p.Params[\"Ep\"]\n            if ep==nil{\n                continue\n            }\n            ret,err:=dm.DeviceMsg.PropertyLogLatestIndex(ctx,\u0026dm.PropertyLogLatestIndexReq{ProductID:subDev.ProductID,DeviceName:subDev.DeviceName,DataIDs:[]string{\"Ep\"}})\n            if err!=nil{\n                log.Print(err)\n                continue\n            }\n            if len(ret.List)==0{\n                 log.Print(\"no property return\")\n                continue\n            }\n            log.Printf(\"ProductID:%v,DeviceName:%v get old:%#v\",subDev.ProductID,subDev.DeviceName,ret.List[0])\n            old:=utils.ToFloat64(ret.List[0].Value)\n            newVal:= utils.ToFloat64(ep)\n            newVal=newVal-old\n            p.Params[\"EpChange\"]=newVal\n         }\n    }\n    req.Payload,err=json.Marshal(tReq)\n     if err!=nil{\n        return nil\n    }\n    log.Printf(\"req:%#v,err:%v\",tReq,err)\n\treturn req\n\treturn req\n}","Desc":"","Status":1,"CreatedTime":"2025-05-15T10:33:43.912+08:00","UpdatedTime":"2025-05-15T15:45:35.762+08:00","CreatedBy":1740358057038188544,"DeletedBy":0,"UpdatedBy":1740358057038188544,"DeletedTime":0,"Devices":[{"ID":1,"TriggerSrc":1,"ProductID":"65","DeviceName":"","ScriptID":1,"Priority":1,"Status":1,"Script":null,"CreatedTime":"2025-05-15T15:45:50.193+08:00","UpdatedTime":"2025-05-15T15:45:50.193+08:00","CreatedBy":1740358057038188544,"DeletedBy":0,"UpdatedBy":0,"DeletedTime":0}]}]